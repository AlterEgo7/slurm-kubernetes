---
apiVersion: v1
kind: Service
metadata:
  name: slurm-master-ssh
  labels:
    app: slurm
    role: slurm-master
spec:
  type: NodePort
  ports:
  - port: 2222
    targetPort: 22
    nodePort: {{ slurm_ssh_port }}
    name: slurm-ssh
  selector:
    role: slurm-master
---
apiVersion: v1
kind: Service
metadata:
  name: slurm
  labels:
    app: slurm
spec:
  clusterIP: None
  ports:
  - port: 6817
    name: slurmctld
  - port: 6818
    name: slurmd
  - port: 22345
    name: drain
  selector:
   app: slurm
---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: slurm
spec:
  serviceName: "slurm"
  replicas: 3
  template:
    metadata:
      labels:
        app: slurm
        role: slurm-node
    spec:
      containers:
      - name: slurmd
        image: {{ slurm_worker_image }}
        imagePullPolicy: Always
        command: ["/bin/bash"]
        args: ["-c", "sleep 5; chown slurm:slurm /data; java -jar /hooks.jar preStart > hooks.log 2>&1; /usr/bin/supervisord --nodaemon"]
        ports:
        - containerPort: 6817
        volumeMounts:
        - name: slurm-config-volume
          mountPath: /usr/local/etc
        - name: gluster-vol1
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - /bin/bash
            - /liveness.sh
          initialDelaySeconds: 60
          periodSeconds: 5
        lifecycle:
          preStop:
            exec:
              command: ["bash", "/preStop.sh"]
        resources:
          limits:
            cpu: 500m
            memory: 512Mi
      - name: kubeapi-proxy
        image: 192.168.62.1:5000/hyperkube:{{ kube_version }}_coreos.0
        command: ["kubectl"]
        args: ["proxy", "-p", "8001"]
        lifecycle:
          preStop:
            exec:
              command: ["bash", "-c", "sleep 40"]
      terminationGracePeriodSeconds: 240
      volumes:
      - name: slurm-config-volume
        configMap:
          name: slurm-config
      - name: gluster-vol1
        persistentVolumeClaim:
          claimName: gluster1
---
apiVersion: v1
kind: Pod
metadata:
  name: slurm-master
  labels:
    app: slurm
    role: slurm-master
spec:
  hostname: slurm-master
  subdomain: slurm
  restartPolicy: Always
  containers:
  - name: slurmctl
    image: {{ slurm_master_image }}
    imagePullPolicy: Always
    command: ["/bin/bash"]
    args: ["-c", "chown slurm:slurm /data; /usr/bin/supervisord --nodaemon"]
    ports:
    - containerPort: 22
    - containerPort: 6818
    volumeMounts:
    - name: slurm-config-volume
      mountPath: /usr/local/etc
    - name: gluster-vol1
      mountPath: /data
    livenessProbe:
      exec:
        command:
        - /bin/bash
        - /liveness.sh
      initialDelaySeconds: 5
      periodSeconds: 5
  volumes:
  - name: slurm-config-volume
    configMap:
      name: slurm-config
  - name: gluster-vol1
    persistentVolumeClaim:
      claimName: gluster1
